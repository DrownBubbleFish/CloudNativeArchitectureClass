:compat-mode:
= Lab 16 - Leveraging Eureka for Service Discovery via Spring Cloud Netflix

[abstract]
--
Let's continue learning the components found in Spring Cloud to implement patterns for distributed systems.
We'll use Spring Cloud Netflix to deploy Eureka, which is a component offering service registration and discovery.

In this lab, we'll do the following:

. Create a Eureka server
. Create two applications, a ``producer'' and a ``consumer,'' wire them up using Eureka, and test them.
. Deploy the Eureka server to Pivotal Web Services
. Update our previously developed microservices to register themselves with Eureka
--

== Creating a Eureka Server

. Change to the lab directory:
+
----
$ cd $COURSE_HOME/day_02/session_05/lab_16/initial/springbox-eureka
----
+
and import the project (via `pom.xml`) into your IDE of choice.

. Open `pom.xml`, change the parent POM to the `spring-cloud-starter-parent`:
+
----
<parent>
  <groupId>org.springframework.cloud</groupId>
  <artifactId>spring-cloud-starter-parent</artifactId>
  <version>1.0.0.RC3</version>
  <relativePath/>
  <!-- lookup parent from repository -->
</parent>
----

. Add the Spring Milestone repository (as Spring Cloud is still pre-GA):
+
----
<repositories>
  <repository>
    <id>spring-milestones</id>
    <name>Spring Milestones</name>
    <url>https://repo.spring.io/libs-milestone/</url>
    <snapshots>
      <enabled>true</enabled>
      </snapshots>
  </repository>
</repositories>
----

. Add a dependency on `spring-cloud-starter-eureka-server`:
+
----
<dependency>
  <groupId>org.springframework.cloud</groupId>
  <artifactId>spring-cloud-starter-eureka-server</artifactId>
</dependency>
----

. Also, update the `spring-boot-maven-plugin` configuration to indicate that jars containing JAX-RS resources should be unpacked:
+
----
<plugin>
  <groupId>org.springframework.boot</groupId>
  <artifactId>spring-boot-maven-plugin</artifactId>
  <configuration>
    <requiresUnpack>
      <dependency>
        <groupId>com.netflix.eureka</groupId>
        <artifactId>eureka-core</artifactId>
      </dependency>
      <dependency>
        <groupId>com.netflix.eureka</groupId>
        <artifactId>eureka-client</artifactId>
      </dependency>
    </requiresUnpack>
  </configuration>
</plugin>
----

. In `io.springbox.eureka.SpringboxEurekaApplication`, add the `@EnableEurekaServer` annotation:
+
----
@SpringBootApplication
@EnableEurekaServer    // <-- ADD THIS!
public class SpringboxEurekaApplication {

    public static void main(String[] args) {
        SpringApplication.run(SpringboxEurekaApplication.class, args);
    }
}
----

. Rename `src/main/resources/application.properties` to `src/main/resources/application.yml`, and paste in the following source:
+
----
server:
  port: 8761

eureka:
  instance:
    hostname: localhost
  client:
    registerWithEureka: false
    fetchRegistry: false
    serviceUrl:
      defaultZone: http://${eureka.instance.hostname}:${server.port}/eureka/
----

. Build the application:
+
----
$ mvn package
----

. Run the application:
+
----
$ java -jar target/springbox-eureka-0.0.1-SNAPSHOT.jar
----

. In a browser, visit http://localhost:8761 and verify that everything is working properly:
+
image::../../../Common/images/eureka_1.png[]

== Create and Register the Producer Service

. Change to the lab directory:
+
----
$ cd $COURSE_HOME/day_02/session_05/lab_16/initial/springbox-producer
----
+
and import the project (via `pom.xml`) into your IDE of choice.

. Open `pom.xml`, change the parent POM to the `spring-cloud-starter-parent`:
+
----
<parent>
  <groupId>org.springframework.cloud</groupId>
  <artifactId>spring-cloud-starter-parent</artifactId>
  <version>1.0.0.RC3</version>
  <relativePath/>
  <!-- lookup parent from repository -->
</parent>
----

. Add the Spring Milestone repository (as Spring Cloud is still pre-GA):
+
----
<repositories>
  <repository>
    <id>spring-milestones</id>
    <name>Spring Milestones</name>
    <url>https://repo.spring.io/libs-milestone/</url>
    <snapshots>
      <enabled>true</enabled>
      </snapshots>
  </repository>
</repositories>
----

. Add a dependency on `spring-cloud-starter` and `spring-cloud-starter-eureka`:
+
----
<dependency>
  <groupId>org.springframework.cloud</groupId>
  <artifactId>spring-cloud-starter</artifactId>
</dependency>
<dependency>
  <groupId>org.springframework.cloud</groupId>
  <artifactId>spring-cloud-starter-eureka</artifactId>
</dependency>
----

. In the package `io.springbox.producer`, create the class `GreetingController`.
Into that class paste the following code:
+
----
@RestController
public class ProducerController {

    private Log log = LogFactory.getLog(ProducerController.class);
    private AtomicInteger counter = new AtomicInteger(0);

    @RequestMapping(value = "/", produces = "application/json")
    public String produce() {
        int value = counter.getAndIncrement();
        log.info("Produced a value: " + value);

        return String.format("{\"value\":%d}", value);
    }

}
----

. Now open `io.springbox.producer.SpringboxProducerApplication` and add the `@EnableDiscoveryClient` annotation:
+
----
@SpringBootApplication
@EnableDiscoveryClient  // <--- ADD THIS!
public class SpringboxProducerApplication {

    public static void main(String[] args) {
        SpringApplication.run(SpringboxProducerApplication.class, args);
    }
}
----

. We'll use our Config Server to consistently configure the Eureka Client across all of our applications.
In your config repo, open `application.yml` and add the following:
+
----
eureka:
  instance:
    leaseRenewalIntervalInSeconds: 10
    metadataMap:
      instanceId: ${vcap.application.instance_id:${spring.application.name}:${server.port:8080}}
----

. Stage, commit, and push your changes:
+
----
git add . && git commit -m "swap greeting" && git push origin master
----

. A completed `springbox-config-server` project has been placed in `$COURSE_HOME/day_02/session_05/lab_15/initial/springbox-config-server` for your convenience.
In a different terminal window, change to that directory, rebuild, and run the application:
+
----
$ cd $COURSE_HOME/day_02/session_05/lab_16/initial/springbox-config-server
$ mvn packaage
$ java -jar target/springbox-config-server-0.0.1-SNAPSHOT.jar
----

. Now build the producer application:
+
----
$ mvn package
----

. And run the producer application:
+
----
$ java -jar target/springbox-producer-0.0.1-SNAPSHOT.jar
----

. Ten seconds after the producer application finishes startup, you should see it log its registration with Eureka:
+
----
2015-02-18 22:56:00.226  INFO 42160 --- [pool-4-thread-1] com.netflix.discovery.DiscoveryClient    : DiscoveryClient_PRODUCER/turkey:producer:8080 - Re-registering apps/PRODUCER
2015-02-18 22:56:00.227  INFO 42160 --- [pool-4-thread-1] com.netflix.discovery.DiscoveryClient    : DiscoveryClient_PRODUCER/turkey:producer:8080: registering service...
2015-02-18 22:56:00.274  INFO 42160 --- [pool-4-thread-1] com.netflix.discovery.DiscoveryClient    : DiscoveryClient_PRODUCER/turkey:producer:8080 - registration status: 204
----
+
You should also be able to refresh http://localhost:8761 in the browser and see the producer registered:
+
image::../../../Common/images/eureka_2.png[]
